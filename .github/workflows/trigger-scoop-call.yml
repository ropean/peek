name: Update Scoop Bucket

on:
  workflow_run:
    workflows: ['Build and Release']
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to update (must start with v)'
        required: true
        type: string

permissions:
  actions: read
  contents: read

jobs:
  get-tag:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag
        id: get-tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
            # Validate that tag starts with 'v'
            if [[ ! "$TAG" =~ ^v ]]; then
              echo "Error: Tag must start with 'v'"
              exit 1
            fi
          else
            # Get the latest tag from the workflow that triggered this
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            
            # If no tag found, try to get from the workflow run event
            if [[ -z "$TAG" ]]; then
              # Check if the head_branch is a tag reference
              if [[ "${{ github.event.workflow_run.head_branch }}" == refs/tags/* ]]; then
                TAG="${{ github.event.workflow_run.head_branch }}"
                TAG="${TAG#refs/tags/}"
              else
                # Last resort: get the most recent tag
                TAG=$(git tag --sort=-version:refname | head -n 1)
              fi
            fi
            
            if [[ -z "$TAG" ]]; then
              echo "Error: Could not determine release tag"
              exit 1
            fi
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Detected tag: $TAG"

  update-scoop:
    needs: get-tag
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    uses: ropean/scoop/.github/workflows/update-scoop-call.yml@main
    with:
      tag: ${{ needs.get-tag.outputs.tag }}

      app_name: 'peek'
      exe_name: 'peek-windows-x64.exe'

      source_repo: ${{ github.repository }}

      description: 'A HTTP inspector, providing a modern GUI for HTTP request testing and analysis.'
      homepage: 'https://peek.aceapp.dev/'
      license_identifier: 'MIT'
      license_url: 'https://github.com/ropean/peek/blob/main/LICENSE'

      shortcut_name: 'peek'
      aliases: 'peek'

      notes: 'Peek is a powerful tool for inspecting and testing HTTP requests.'

    secrets:
      source_repo_token: ${{ secrets.GITHUB_TOKEN }}
      deploy_key: ${{ secrets.SCOOP_ROPEAN_DEPLOY_KEY }}
